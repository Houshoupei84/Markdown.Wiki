##CR三阶段提测文档

###1.新增提案

#### 1.1提案终止另外一个提案

https://trello.com/c/CmhHsVZQ

# 业务逻辑

和以前的CRCProposal结构一致，变动较小
1.添加新的提案类型
2.添加字段：【待中止提案hash】
3.该提案过了评议期，公投期那么另外一个提案被中止
4.budgets和ELA接受地址都不需要

# 验证规则汇总

1.提案类型为中止提案：CloseProposal
[2.CR](http://2.cr/)签名及Owner签名验签通过
3.【待中止提案hash】对应的提案存在VoterAgreed；
4.发起人必须是委员（待聪姐戴循确认）
5.提案Voter



####1.2提案更换提案负责人

https://trello.com/c/0WL0SZxB

# 业务逻辑

1.添加新的提案类型
2.新增 【更换负责人对应的提案hash】 字段
3.新增 【新负责人PublicKey】 字段
4.支持 ELA接受地址变更
5.过了评议期，公投期那么【更换负责人对应的提案hash】对应提案负责人及ELA接受地址更换成功

# 验证规则汇总

1.提案类型为更换提案负责人：ChangeProposalOwner
[2.CR](http://2.cr/)签名及Owner签名验签通过
3.需要处于当选期且不在投票期
4.需要 【更换负责人对应的提案hash 】对应的提案存在，且状态为VoterAgreed
5.需要 【新负责人PublicKey】和以前的did不同
6.发起人必须是委员（待定）



####1.3提案选举秘书长

https://trello.com/c/LnlyoHqX



# 业务逻辑

[1.CR](http://1.cr/)网页上现任委员发起意见
意见包括 【新秘书长publickey】【新秘书长DID】
2.发起人对意见进行签名
3.新秘书长进行签名【新秘书长签名】
4.委员进行推荐，签名
（上述总共3个签名）
5.过了评议期，公投期那么当前的秘书长就变更成功了
6.不需要 预算款 以及ELA接受地址Recipient

# 验证规则汇总

1.提案类型为秘书长选举：SecretaryGeneral
2.验证提案发起人是不是委员
3.验证【新秘书长publickey】【新秘书长DID】合法性
4.预算款 以及ELA接受地址Recipient为空
5.三个签名验签通过
6.需要处于当选期且不在投票期



### 2.CR二阶段遗留问题处理

#### 2.1CR总地址零钱换整

https://trello.com/c/gewQP3fE



# 起因

由于当前换届拨款交易会自动获取CR总地址的金额的10%转给CR运营地址，所以一年会有接近3w的utxo，目前链上不支持这样大量的utxo在一个交易里。

# 解决方案

根据当前CR总地址（CRAssetsAddress）的UTXO数量，发现大于一定数量则进行一次零钱换整，将一定数量的（比如3000）utxo换整到自己的地址

- 检查UTXO数量，大于一定数量则触发创建零钱换整交易
- 创建零钱换整规则和创建换届拨款一样，获取未锁定的utxo生成交易，并发送到交易池；每个节点都进行创建，且要保证交易hash是同一个
- 内存状态记录是否下一个块需要带有换整交易，如果需要，检查下一个区块时要求区块必须带有换整交易
- 交易打包优先打包的交易需要包括此零钱换整交易
- 零钱换整交易需要固定手续费（目前定1wsela）
- 考虑兼容性，升级后从某个高度开始处理，一个区块只创建一次换整交易

# 讨论（已调整解决方案）

**换整交易不要求下一个区块必须打包**
实现过程中发现，其实可以不强制要求下一个区块必须带有换整交易
只需要检查，新的交易里这个换整交易 inputs， outputs必须都是从拨款地址出来，且inputs大于我们认为需要换整的个数，outputs必须为1个，且inputs=outputs的金额。

好处：
1.不会因为该交易无法创建等问题导致链卡住
2.这个交易不需要签名，但是强制验证只能换整且金额不变，链创建不成功时，可以由人为手动创建
3.交易因为是utxo换整，虽然没有fee也不会发起多个交易来进行攻击（交易池有utxo排重）

可能的风险：
1.只是说因为上线的时间落后，可能有人刚好升级后作恶，故意创建很多的这种拨款交易（把所有的utxo都给换整，前提是utxo不重复），那么可能交易过多，链打包起来处理速度会比较慢
如果说9月上线 可能3个月 3*30*720 = 64,800，其实感觉也还好，就算作恶影响也不大
2.0手续费不做强制要求的话，矿工可能不乐意打包,改为固定手续费：比如10000sela

# 规则

- 要求inputs数量必须不小于720个，不大于1440
- outputs只能是一个
- 所有的inputs与outputs都是CRAssetsAddress对应的program hash
- 不需要签名
- 交易fee为10000sela（可配置）



#### 2.2新版提案取款交易

https://trello.com/c/q9Cyoegp

# 起因

新创建的SPV钱包由于无法非中心化获取CR运营地址的UTXO，需要链上调整提案取款交易。

# 方案

- 钱包创建提案取款交易，不直接动用CR运营地址的UTXO
- 链上发现新版的提案取款交易a，则生成另一个提案取款交易b将CR运营地址的UTXO转到提案取款指定的地址
- 第二个提案取款交易支持多个提案取款交易a生成一个提案交易b
- 不强制要求下一个区块必须带有实际取款的提案交易b
- 链上按某个高度后不支持旧版的提案取款交易

# 结构

钱包生成的新版提案交易， payload结构：
\- 提案hash
\- 提款金额
\- 提款地址
\- 签名
提案交易b：将多个提案a生成一个提案b要求下一个区块打包
单个提案取款交易手续费1wsela

# 规则

钱包创建的交易验证：
\- 金额与可取款金额一致
\- 取款地址与Recipient地址一致
\- 需要支付手续费
\- 提款金额不能小于或等于10000sela（RealWithdrawSingleFee)

链上自动生成的交易：
\- hash列表对应钱包创建的交易的hash
\- hash列表里的交易没被处理过
\- hash列表里的交易不重复
\- hash列表与output一一对应
\- output如果有找零需要放在最后边
\- hash列表里每多一条交易fee多10000sela（体现在output到账，每个地址会少10000sela, 可用过RealWithdrawSingleFee 指定）





### 3.其它

#### 3.1提案追踪Rejected类型调整

不再验证stage是否满足条件，stage如果为尾款也能改变尾款的状态为rejected

#### 3.2添加rpc接口 getcrrelatedstage

用于获取当前是否处于当选期，是否处于投票期，并预估结束时间。投票如果么出结果延长投票期则投票开始时间会重置为新的开始时间。